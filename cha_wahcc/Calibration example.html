<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Miquel Perello Nieto">
<meta name="dcterms.date" content="2023-03-27">

<title>Foundations of Trustworthy AI - 6&nbsp; Calibration example</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../safety-and-robustness.html" rel="next">
<link href="../cha_wahcc/wahcc.html" rel="prev">
<link href="../cropped-tailor-logo-symbol-32x32.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<link rel="stylesheet" media="screen" href="../fonts/Myriad Pro Regular.ttf" type="text/css">

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<link rel="stylesheet" href="../style.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Calibration example</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../TAILOR logo - full-color rgb.svg" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Foundations of Trustworthy AI</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/TAILOR-UoB/mooc_trustworthy_ai" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle sidebar-tool" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle sidebar-tool" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../intro.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">(Introduction)</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../explainable-ai-systems.html" class="sidebar-item-text sidebar-link">Explainable AI systems</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../xais-fea-imp.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">(Feature Importance)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../xais-sal-map.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">(Saliency Maps)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../xais-sin-tre.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">(Single Tree Approximation)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../cha_wahcc/wahcc.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Classifier Calibration</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../cha_wahcc/Calibration example.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Calibration example</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../safety-and-robustness.html" class="sidebar-item-text sidebar-link">(Safety and Robustness)</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../cha_unc/uncertainty.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Some recent COVID-19 data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../sar-ali.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">(Alignment)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../sar-rob.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">(Robustness)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../sar-rel.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">(Reliability)</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">(Fairness, Equity, and Justice by Design)</span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">Accountability and Reproducibility (placeholder)</span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">(Respect for Privacy)</span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">(Sustainability)</span>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#visualisation-and-evaluation-tools" id="toc-visualisation-and-evaluation-tools" class="nav-link active" data-scroll-target="#visualisation-and-evaluation-tools"><span class="toc-section-number">6.1</span>  # Visualisation and evaluation tools</a></li>
  <li><a href="#binary-dataset" id="toc-binary-dataset" class="nav-link" data-scroll-target="#binary-dataset"><span class="toc-section-number">6.2</span>  Binary dataset</a></li>
  <li><a href="#reliability-diagram" id="toc-reliability-diagram" class="nav-link" data-scroll-target="#reliability-diagram"><span class="toc-section-number">6.3</span>  Reliability diagram</a>
  <ul class="collapse">
  <li><a href="#multiclass" id="toc-multiclass" class="nav-link" data-scroll-target="#multiclass">Multiclass</a></li>
  </ul></li>
  <li><a href="#calibration-maps" id="toc-calibration-maps" class="nav-link" data-scroll-target="#calibration-maps"><span class="toc-section-number">6.4</span>  Calibration maps</a>
  <ul class="collapse">
  <li><a href="#binary" id="toc-binary" class="nav-link" data-scroll-target="#binary">Binary</a></li>
  <li><a href="#ternary-calibration-maps" id="toc-ternary-calibration-maps" class="nav-link" data-scroll-target="#ternary-calibration-maps">Ternary Calibration maps</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.dev/TAILOR-UoB/mooc_trustworthy_ai/blob/master/cha_wahcc/Calibration example.ipynb" class="toc-action">Edit this page</a></p><p><a href="https://github.com/TAILOR-UoB/mooc_trustworthy_ai/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Calibration example</span></h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Miquel Perello Nieto </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 27, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="visualisation-and-evaluation-tools" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="visualisation-and-evaluation-tools"><span class="header-section-number">6.1</span> # Visualisation and evaluation tools</h2>
<p>In this Section, we will demonstrate some tools to visualise how calibrated your models are. We will get some intuition about what correction is applying a calibrator, and some calibration evaluation measures.</p>
<div class="cell" data-execution_count="1">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="op">%</span>precision <span class="dv">2</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="im">import</span> warnings<span class="op">;</span> warnings.simplefilter(<span class="st">'ignore'</span>)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="im">import</span> pycalib</span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb1-9"><a href="#cb1-9"></a></span>
<span id="cb1-10"><a href="#cb1-10"></a>plt.rcParams[<span class="st">'figure.figsize'</span>] <span class="op">=</span> (<span class="dv">5</span>, <span class="dv">4</span>)</span>
<span id="cb1-11"><a href="#cb1-11"></a>plt.rcParams[<span class="st">"figure.autolayout"</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>plt.rcParams[<span class="st">"savefig.bbox"</span>] <span class="op">=</span> <span class="st">'tight'</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="co">#plt.rcParams['axes.prop_cycle'] = plt.cycler(color=plt.cm.Set1.colors)</span></span>
<span id="cb1-14"><a href="#cb1-14"></a></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="im">from</span> pycalib.metrics <span class="im">import</span> binary_ECE, binary_MCE, conf_ECE, conf_MCE, classwise_ECE, classwise_MCE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="binary-dataset" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="binary-dataset"><span class="header-section-number">6.2</span> Binary dataset</h2>
<p>We will start with a simple binary dataset composed by some blobs. You can change the dataset here to any binary one but the rest of the text assumes the first example is being used.</p>
<div class="cell" data-execution_count="2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> make_blobs</span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a>dataset_binary <span class="op">=</span> make_blobs(n_samples<span class="op">=</span><span class="dv">10000</span>, centers<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb2-4"><a href="#cb2-4"></a>                            n_features<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb2-5"><a href="#cb2-5"></a>                            random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a>dataset_binary[<span class="dv">1</span>][:] <span class="op">=</span> dataset_binary[<span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Each dataset is just composed by the features <span class="math inline">x</span> and labels <span class="math inline">y</span>. The following is a scatterplot of the dataset.</p>
<div class="cell" data-execution_count="3">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a>x, y <span class="op">=</span> dataset_binary</span>
<span id="cb3-2"><a href="#cb3-2"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb3-3"><a href="#cb3-3"></a>scatter <span class="op">=</span> ax.scatter(x[:, <span class="dv">0</span>], x[:, <span class="dv">1</span>], c<span class="op">=</span>y, edgecolors<span class="op">=</span> <span class="st">"black"</span>, cmap<span class="op">=</span><span class="st">"viridis_r"</span>)</span>
<span id="cb3-4"><a href="#cb3-4"></a>handles, labels <span class="op">=</span> scatter.legend_elements()</span>
<span id="cb3-5"><a href="#cb3-5"></a>labels <span class="op">=</span> [<span class="st">'Negative'</span>, <span class="st">'Positive'</span>]</span>
<span id="cb3-6"><a href="#cb3-6"></a>legend <span class="op">=</span> ax.legend(handles, labels,</span>
<span id="cb3-7"><a href="#cb3-7"></a>                    loc<span class="op">=</span><span class="st">"lower right"</span>, title<span class="op">=</span><span class="st">"Classes"</span>)</span>
<span id="cb3-8"><a href="#cb3-8"></a>ax.add_artist(legend)</span>
<span id="cb3-9"><a href="#cb3-9"></a>ax.grid()</span>
<span id="cb3-10"><a href="#cb3-10"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-4-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="reliability-diagram" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="reliability-diagram"><span class="header-section-number">6.3</span> Reliability diagram</h2>
<p>We will first train a classifier and see how calibrated it is with a reliability diagram. We will load first the previously generated binary dataset.</p>
<div class="cell" data-execution_count="4">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a>x, y <span class="op">=</span> dataset_binary</span>
<span id="cb4-4"><a href="#cb4-4"></a>x_train, x_test, y_train, y_test <span class="op">=</span> train_test_split(x, y, test_size<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we will train a binary classifier.</p>
<div class="cell" data-execution_count="5">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="im">from</span> sklearn.naive_bayes <span class="im">import</span> GaussianNB</span>
<span id="cb5-2"><a href="#cb5-2"></a>clf_bin <span class="op">=</span> GaussianNB()</span>
<span id="cb5-3"><a href="#cb5-3"></a>clf_bin.fit(x_train, y_train)</span>
<span id="cb5-4"><a href="#cb5-4"></a></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="bu">print</span>(<span class="st">'Priors </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(clf_bin.class_prior_))</span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="bu">print</span>(<span class="st">'Absolute additive value to the variances </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(clf_bin.epsilon_))</span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="bu">print</span>(<span class="st">'Variances </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(clf_bin.sigma_))</span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="bu">print</span>(<span class="st">'Mean </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(clf_bin.theta_))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Priors [0.6 0.4]
Absolute additive value to the variances 3.226318807172663e-08
Variances [[23.57 43.55]
 [30.53  3.54]]
Mean [[-1.63  1.34]
 [-3.33  5.76]]</code></pre>
</div>
</div>
<p>Now, we will check what are the probabilities output by the classifier in the different regions of the feature space.</p>
<div class="cell" data-execution_count="6">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a>delta <span class="op">=</span> <span class="fl">0.25</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>x0_grid <span class="op">=</span> np.arange(x[:, <span class="dv">0</span>].<span class="bu">min</span>(), x[:, <span class="dv">0</span>].<span class="bu">max</span>(), delta)</span>
<span id="cb7-3"><a href="#cb7-3"></a>x1_grid <span class="op">=</span> np.arange(x[:, <span class="dv">1</span>].<span class="bu">min</span>(), x[:, <span class="dv">1</span>].<span class="bu">max</span>(), delta)</span>
<span id="cb7-4"><a href="#cb7-4"></a>X0, X1 <span class="op">=</span> np.meshgrid(x0_grid, x1_grid)</span>
<span id="cb7-5"><a href="#cb7-5"></a>Y <span class="op">=</span> clf_bin.predict_proba(np.vstack((X0.flatten(), X1.flatten())).T)</span>
<span id="cb7-6"><a href="#cb7-6"></a></span>
<span id="cb7-7"><a href="#cb7-7"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb7-8"><a href="#cb7-8"></a>CS <span class="op">=</span> ax.contour(X0, X1, Y[:, <span class="dv">1</span>].reshape(X0.shape),</span>
<span id="cb7-9"><a href="#cb7-9"></a>                levels<span class="op">=</span>[<span class="fl">.1</span>, <span class="fl">.3</span>, <span class="fl">.5</span>, <span class="fl">.7</span>, <span class="fl">.9</span>])</span>
<span id="cb7-10"><a href="#cb7-10"></a>ax.clabel(CS, inline<span class="op">=</span><span class="dv">1</span>, fmt<span class="op">=</span><span class="st">'</span><span class="sc">%1.1f</span><span class="st">'</span>, fontsize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb7-11"><a href="#cb7-11"></a>ax.scatter(x_test[:<span class="dv">75</span>, <span class="dv">0</span>], x_test[:<span class="dv">75</span>, <span class="dv">1</span>], c<span class="op">=</span>y_test[:<span class="dv">75</span>], edgecolors<span class="op">=</span> <span class="st">"black"</span>, cmap<span class="op">=</span><span class="st">"viridis_r"</span>)</span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="co">#ax.set_title('Predicted probabilities')</span></span>
<span id="cb7-13"><a href="#cb7-13"></a></span>
<span id="cb7-14"><a href="#cb7-14"></a>ax.text(clf_bin.theta_[<span class="dv">0</span>][<span class="dv">0</span>], clf_bin.theta_[<span class="dv">0</span>][<span class="dv">1</span>], <span class="st">"$\mu_1$"</span>, ha<span class="op">=</span><span class="st">"center"</span>, va<span class="op">=</span><span class="st">"center"</span>, size<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb7-15"><a href="#cb7-15"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"circle,pad=0.3"</span>, fc<span class="op">=</span><span class="st">"yellow"</span>, ec<span class="op">=</span><span class="st">"black"</span>, lw<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb7-16"><a href="#cb7-16"></a>ax.text(clf_bin.theta_[<span class="dv">1</span>][<span class="dv">0</span>], clf_bin.theta_[<span class="dv">1</span>][<span class="dv">1</span>], <span class="st">"$\mu_2$"</span>, ha<span class="op">=</span><span class="st">"center"</span>, va<span class="op">=</span><span class="st">"center"</span>, size<span class="op">=</span><span class="dv">12</span>, color<span class="op">=</span><span class="st">'white'</span>,</span>
<span id="cb7-17"><a href="#cb7-17"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"circle,pad=0.3"</span>, fc<span class="op">=</span><span class="st">"blue"</span>, ec<span class="op">=</span><span class="st">"black"</span>, lw<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb7-18"><a href="#cb7-18"></a></span>
<span id="cb7-19"><a href="#cb7-19"></a>ax.grid()</span>
<span id="cb7-20"><a href="#cb7-20"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-7-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We can also look at the positive scores given by the classifeir to each test sample. In the following figure we just numbered every instance with an increasing number and we show the corresponding output score. Then on the right we show a histogram of all the scores.</p>
<div class="cell" data-execution_count="7">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a>n_bins <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>bins <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, n_bins<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a>p_clf <span class="op">=</span> clf_bin.predict_proba(x_test)</span>
<span id="cb8-5"><a href="#cb8-5"></a>fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">3</span>))</span>
<span id="cb8-6"><a href="#cb8-6"></a>ax1.scatter(<span class="bu">range</span>(<span class="dv">75</span>), p_clf[:<span class="dv">75</span>,<span class="dv">1</span>], c<span class="op">=</span>y_test[:<span class="dv">75</span>], s<span class="op">=</span><span class="dv">30</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, cmap<span class="op">=</span><span class="st">"viridis_r"</span>)</span>
<span id="cb8-7"><a href="#cb8-7"></a>ax1.set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb8-8"><a href="#cb8-8"></a>ax1.grid()</span>
<span id="cb8-9"><a href="#cb8-9"></a>ax1.set_xlabel(<span class="st">'instance index'</span>)</span>
<span id="cb8-10"><a href="#cb8-10"></a>ax1.set_ylabel(<span class="st">'predicted proba'</span>)</span>
<span id="cb8-11"><a href="#cb8-11"></a>ax2.hist([p_clf[y_test <span class="op">==</span> <span class="dv">0</span>, <span class="dv">1</span>],</span>
<span id="cb8-12"><a href="#cb8-12"></a>          p_clf[y_test <span class="op">==</span> <span class="dv">1</span>, <span class="dv">1</span>]],</span>
<span id="cb8-13"><a href="#cb8-13"></a>         bins<span class="op">=</span>bins, orientation<span class="op">=</span><span class="st">'horizontal'</span>, stacked<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-14"><a href="#cb8-14"></a>         color<span class="op">=</span>[<span class="st">'yellow'</span>, <span class="st">'blue'</span>], edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb8-15"><a href="#cb8-15"></a>ax2.set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb8-16"><a href="#cb8-16"></a>ax2.grid()</span>
<span id="cb8-17"><a href="#cb8-17"></a>ax2.set_xlabel(<span class="st">'samples per bin'</span>)</span>
<span id="cb8-18"><a href="#cb8-18"></a>plt.tight_layout()</span>
<span id="cb8-19"><a href="#cb8-19"></a>fig.savefig(<span class="st">'cal_1_vis_hist.pdf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-9-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We can clearly see that the model gives lower scores to the negative class. We can also see that most of the negative instances are in the range of scores between 0 and 0.1. And notice that the last bin between 0.9 and 1.0 does not contain any sample.</p>
<p>Now, in order to plot the reliability diagram we need to compute the mean scores in each of the bins, as well as the true proportion of positives.</p>
<p>We start by assigning each of the instances to the corresponding bin. The function digitize from Numpy returns the index of the corresponding bin for each instance.</p>
<div class="cell" data-execution_count="8">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a>digitized <span class="op">=</span> np.digitize(p_clf[:, <span class="dv">1</span>], bins<span class="op">=</span>bins)</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="bu">print</span>(<span class="st">'Bins = </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(bins))</span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="bu">print</span>(digitized)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Bins = [0.  0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1. ]
[1 1 7 ... 9 1 6]</code></pre>
</div>
</div>
<p>Now we can compute the mean score in each bin</p>
<div class="cell" data-execution_count="9">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a>pred_means <span class="op">=</span> [p_clf[:, <span class="dv">1</span>][digitized <span class="op">==</span> i].mean() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n_bins<span class="op">+</span><span class="dv">1</span>)]</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="bu">print</span>(pred_means)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[0.012432487052501908, 0.15203439630231722, 0.24868816147980233, 0.35145643469960997, 0.45029774080111806, 0.5534547383794531, 0.6486686394892508, 0.7595789271035308, 0.8238768795804186, nan]</code></pre>
</div>
</div>
<p>Notice that the last bin does not contain any sample, and thus it is assigned a NaN. Now we compute the true positive rate in each bin (or the average value of zeros and ones).</p>
<div class="cell" data-execution_count="10">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a>y_means <span class="op">=</span> [y_test[digitized <span class="op">==</span> i].mean() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n_bins<span class="op">+</span><span class="dv">1</span>)]</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="bu">print</span>(y_means)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[0.000777000777000777, 0.03208556149732621, 0.11538461538461539, 0.22282608695652173, 0.39461883408071746, 0.5326633165829145, 0.7228017883755589, 0.9419354838709677, 1.0, nan]</code></pre>
</div>
</div>
<p>We can now plot a line with the mean scores in the <span class="math inline">x</span> axis and the true positive rate on the <span class="math inline">y</span> axis. We will also show a histogram with the positive and negative samples per bin.</p>
<div class="cell" data-execution_count="11">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a>fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb15-2"><a href="#cb15-2"></a>ax1.plot(pred_means, y_means, <span class="st">'o-'</span>)</span>
<span id="cb15-3"><a href="#cb15-3"></a>ax1.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">'r--'</span>)</span>
<span id="cb15-4"><a href="#cb15-4"></a>ax1.set_xlim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb15-5"><a href="#cb15-5"></a>ax1.set_xlabel(<span class="st">'Mean predicted value'</span>)</span>
<span id="cb15-6"><a href="#cb15-6"></a>ax1.set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb15-7"><a href="#cb15-7"></a>ax1.set_ylabel(<span class="st">'Fraction of positives'</span>)</span>
<span id="cb15-8"><a href="#cb15-8"></a>ax1.grid()</span>
<span id="cb15-9"><a href="#cb15-9"></a></span>
<span id="cb15-10"><a href="#cb15-10"></a>ax2.hist([p_clf[y_test <span class="op">==</span> <span class="dv">0</span>, <span class="dv">1</span>],</span>
<span id="cb15-11"><a href="#cb15-11"></a>          p_clf[y_test <span class="op">==</span> <span class="dv">1</span>, <span class="dv">1</span>]],</span>
<span id="cb15-12"><a href="#cb15-12"></a>         bins<span class="op">=</span>bins, orientation<span class="op">=</span><span class="st">'vertical'</span>, stacked<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb15-13"><a href="#cb15-13"></a>         color<span class="op">=</span>[<span class="st">'yellow'</span>, <span class="st">'b'</span>], edgecolor<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb15-14"><a href="#cb15-14"></a>         label<span class="op">=</span>[<span class="st">'Neg.'</span>, <span class="st">'Pos.'</span>])</span>
<span id="cb15-15"><a href="#cb15-15"></a>ax2.legend()</span>
<span id="cb15-16"><a href="#cb15-16"></a>ax2.set_xlim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb15-17"><a href="#cb15-17"></a>ax2.set_xlabel(<span class="st">'Predicted probabilities'</span>)</span>
<span id="cb15-18"><a href="#cb15-18"></a>ax2.set_ylabel(<span class="st">'Samples per bin'</span>)</span>
<span id="cb15-19"><a href="#cb15-19"></a>ax2.grid()</span>
<span id="cb15-20"><a href="#cb15-20"></a>plt.tight_layout()</span>
<span id="cb15-21"><a href="#cb15-21"></a>plt.savefig(<span class="st">'cal_1_vis_rel_diag_and_hist.pdf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We can see in the previous reliability diagram that the model is</p>
<ul>
<li>over-confident in the lower range of scores: predicts scores of 0.2 when the true proportion of positives is around 10%.</li>
<li>under-confident in the higher range of scores: predicts scores of 0.8 when the true proportion of positives is 100%.</li>
</ul>
<p>The red diagonal shows the reliability diagram for a calibrated model which always predicts the true proportion of positives.</p>
<p>We can show the <strong>correction</strong> that should be applied to the scores for the model to be calibrated.</p>
<div class="cell" data-execution_count="13">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">7</span>))</span>
<span id="cb16-2"><a href="#cb16-2"></a>ax1.plot(pred_means, y_means, <span class="st">'o-'</span>)</span>
<span id="cb16-3"><a href="#cb16-3"></a>ax1.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">'r--'</span>)</span>
<span id="cb16-4"><a href="#cb16-4"></a></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="cf">for</span> x, y <span class="kw">in</span> <span class="bu">zip</span>(pred_means, y_means):</span>
<span id="cb16-6"><a href="#cb16-6"></a>    ax1.arrow(x, y, y<span class="op">-</span>x, y<span class="op">-</span>y, width<span class="op">=</span><span class="fl">0.005</span>, length_includes_head<span class="op">=</span><span class="va">True</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb16-7"><a href="#cb16-7"></a></span>
<span id="cb16-8"><a href="#cb16-8"></a>ax1.set_xlim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb16-9"><a href="#cb16-9"></a>ax1.set_xlabel(<span class="st">'Mean predicted value'</span>)</span>
<span id="cb16-10"><a href="#cb16-10"></a>ax1.set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb16-11"><a href="#cb16-11"></a>ax1.set_ylabel(<span class="st">'Fraction of positives'</span>)</span>
<span id="cb16-12"><a href="#cb16-12"></a>ax1.grid()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-14-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Lets train a different classifier in order to compare with the previous one</p>
<div class="cell" data-execution_count="14">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a><span class="im">from</span> sklearn.neighbors <span class="im">import</span> KNeighborsClassifier</span>
<span id="cb17-2"><a href="#cb17-2"></a></span>
<span id="cb17-3"><a href="#cb17-3"></a>clf_bin_2 <span class="op">=</span> KNeighborsClassifier(n_neighbors<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb17-4"><a href="#cb17-4"></a>clf_bin_2.fit(x_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>KNeighborsClassifier(n_neighbors=10)</code></pre>
</div>
</div>
<p>In the PyCalib library we can directly call a function to plot the reliability diagram for a list of output scores, in this case we will demonstrate with the previously trained classifiers</p>
<div class="cell" data-execution_count="15">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a><span class="im">from</span> pycalib.visualisations <span class="im">import</span> plot_reliability_diagram</span>
<span id="cb19-2"><a href="#cb19-2"></a></span>
<span id="cb19-3"><a href="#cb19-3"></a>scores_list <span class="op">=</span> [clf_bin.predict_proba(x_test),</span>
<span id="cb19-4"><a href="#cb19-4"></a>               clf_bin_2.predict_proba(x_test)]</span>
<span id="cb19-5"><a href="#cb19-5"></a></span>
<span id="cb19-6"><a href="#cb19-6"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb19-7"><a href="#cb19-7"></a>plot_reliability_diagram(y_test, scores_list, legend<span class="op">=</span>(<span class="st">'NaiveBayes'</span>, <span class="st">'KNN (k=10)'</span>), class_names<span class="op">=</span>[<span class="st">'Neg.'</span>, <span class="st">'Pos.'</span>],</span>
<span id="cb19-8"><a href="#cb19-8"></a>                         fig<span class="op">=</span>fig)<span class="op">;</span></span>
<span id="cb19-9"><a href="#cb19-9"></a>plt.tight_layout()</span>
<span id="cb19-10"><a href="#cb19-10"></a>plt.savefig(<span class="st">'cal_1_vis_rel_dia_nb_knn.pdf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="16">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb20-2"><a href="#cb20-2"></a>plot_reliability_diagram(y_test, scores_list, legend<span class="op">=</span>(<span class="st">'NaiveBayes'</span>, <span class="st">'KNN (k=10)'</span>), class_names<span class="op">=</span>[<span class="st">'Neg.'</span>, <span class="st">'Pos.'</span>],</span>
<span id="cb20-3"><a href="#cb20-3"></a>                         fig<span class="op">=</span>fig, show_counts<span class="op">=</span><span class="va">True</span>, show_histogram<span class="op">=</span><span class="va">False</span>)<span class="op">;</span></span>
<span id="cb20-4"><a href="#cb20-4"></a>plt.tight_layout()</span>
<span id="cb20-5"><a href="#cb20-5"></a>plt.savefig(<span class="st">'cal_1_vis_rel_dia_count_nb_knn.pdf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="17">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a><span class="bu">help</span>(plot_reliability_diagram)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Help on function plot_reliability_diagram in module pycalib.visualisations:

plot_reliability_diagram(labels, scores, legend=None, show_histogram=True, bins=10, class_names=None, fig=None, show_counts=False, errorbar_interval=None, interval_method='beta', fmt='s-', show_correction=False, show_gaps=False, sample_proportion=0, hist_per_class=False, color_list=None, show_bars=False, invert_histogram=False, color_gaps='lightcoral', confidence=False)
    Plots the reliability diagram of the given scores and true labels
    
    Parameters
    ==========
    labels : array (n_samples, )
        Labels indicating the true class.
    scores : matrix (n_samples, n_classes) or list of matrices
        Output probability scores for one or several methods.
    legend : list of strings or None
        Text to use for the legend.
    show_histogram : boolean
        If True, it generates an additional figure showing the number of
        samples in each bin.
    bins : int or list of floats
        Number of bins to create in the scores' space, or list of bin
        boundaries.
    class_names : list of strings or None
        Name of each class, if None it will assign integer numbers starting
        with 1.
    fig : matplotlib.pyplot.Figure or None
        Figure to use for the plots, if None a new figure is created.
    show_counts : boolean
        If True shows the number of samples of each bin in its corresponding
        line marker.
    errorbar_interval : float or None
        If a float between 0 and 1 is passed, it shows an errorbar
        corresponding to a confidence interval containing the specified
        percentile of the data.
    interval_method : string (default: 'beta')
        Method to estimate the confidence interval which uses the function
        proportion_confint from statsmodels.stats.proportion
    fmt : string (default: 's-')
        Format of the lines following the matplotlib.pyplot.plot standard.
    show_correction : boolean
        If True shows an arrow for each bin indicating the necessary correction
        to the average scores in order to be perfectly calibrated.
    show_gaps : boolean
        If True shows the gap between the average predictions and the true
        proportion of positive samples.
    sample_proportion : float in the interval [0, 1] (default 0)
        If bigger than 0, it shows the labels of the specified proportion of
        samples.
    hist_per_class : boolean
        If True shows one histogram of the bins per class.
    color_list : list of strings or None
        List of string colors indicating the color of each method.
    show_bars : boolean
        If True shows bars instead of lines.
    invert_histogram : boolean
        If True shows the histogram with the zero on top and highest number of
        bin samples at the bottom.
    color_gaps : string
        Color of the gaps (if shown).
    confidence : boolean
        If True shows only the confidence reliability diagram.
    
    Regurns
    =======
    fig : matplotlib.pyplot.figure
        Figure with the reliability diagram
</code></pre>
</div>
</div>
<div class="cell" data-execution_count="18">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1"></a>clf_bin.predict_proba(x_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>array([[1.00e+00, 7.62e-08],
       [1.00e+00, 1.72e-10],
       [3.86e-01, 6.14e-01],
       ...,
       [1.64e-01, 8.36e-01],
       [1.00e+00, 3.91e-09],
       [4.26e-01, 5.74e-01]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="19">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1"></a><span class="bu">print</span>(<span class="st">'Naive Bayes bin-ECE = '</span>, binary_ECE(y_test, clf_bin.predict_proba(x_test)[:,<span class="dv">1</span>], bins<span class="op">=</span>n_bins))</span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="bu">print</span>(<span class="st">'KNN bin-ECE = '</span>, binary_ECE(y_test,  clf_bin_2.predict_proba(x_test)[:,<span class="dv">1</span>], bins<span class="op">=</span>n_bins))</span>
<span id="cb25-3"><a href="#cb25-3"></a></span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="bu">print</span>(<span class="st">'Naive Bayes bin-MCE = '</span>, binary_MCE(y_test, clf_bin.predict_proba(x_test)[:,<span class="dv">1</span>], bins<span class="op">=</span>n_bins))</span>
<span id="cb25-5"><a href="#cb25-5"></a><span class="bu">print</span>(<span class="st">'KNN bin-MCE = '</span>, binary_MCE(y_test,  clf_bin_2.predict_proba(x_test)[:,<span class="dv">1</span>], bins<span class="op">=</span>n_bins))</span>
<span id="cb25-6"><a href="#cb25-6"></a></span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="bu">print</span>(<span class="st">'Naive Bayes conf-ECE = '</span>, conf_ECE(y_test, clf_bin.predict_proba(x_test), bins<span class="op">=</span>n_bins))</span>
<span id="cb25-8"><a href="#cb25-8"></a><span class="bu">print</span>(<span class="st">'KNN conf-ECE = '</span>, conf_ECE(y_test,  clf_bin_2.predict_proba(x_test), bins<span class="op">=</span>n_bins))</span>
<span id="cb25-9"><a href="#cb25-9"></a></span>
<span id="cb25-10"><a href="#cb25-10"></a><span class="bu">print</span>(<span class="st">'Naive Bayes conf-MCE = '</span>, conf_MCE(y_test, clf_bin.predict_proba(x_test), bins<span class="op">=</span>n_bins))</span>
<span id="cb25-11"><a href="#cb25-11"></a><span class="bu">print</span>(<span class="st">'KNN conf-MCE = '</span>, conf_MCE(y_test,  clf_bin_2.predict_proba(x_test), bins<span class="op">=</span>n_bins))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Naive Bayes bin-ECE =  0.08079967025663184
KNN bin-ECE =  0.005960000000000007
Naive Bayes bin-MCE =  0.1823565567674369
KNN bin-MCE =  0.09999999999999976
Naive Bayes conf-ECE =  0.07583467873161782
KNN conf-ECE =  0.00683999999999987
Naive Bayes conf-MCE =  0.16170908776716286
KNN conf-MCE =  0.06666666666666787</code></pre>
</div>
</div>
<p>We can also see a visualisation that emphasizes the gaps between the proportions of positives of each bin and the perfect diagonal.</p>
<p>In this case we will show it for the first classifier.</p>
<div class="cell" data-execution_count="20">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1"></a><span class="im">from</span> pycalib.visualisations <span class="im">import</span> plot_binary_reliability_diagram_gaps</span>
<span id="cb27-2"><a href="#cb27-2"></a></span>
<span id="cb27-3"><a href="#cb27-3"></a>est_scores <span class="op">=</span> clf_bin.predict_proba(x_test)</span>
<span id="cb27-4"><a href="#cb27-4"></a></span>
<span id="cb27-5"><a href="#cb27-5"></a>fig, ax <span class="op">=</span> plot_binary_reliability_diagram_gaps(y_test, est_scores, n_bins<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb27-6"><a href="#cb27-6"></a>_ <span class="op">=</span> ax.set_title(<span class="st">'Reliability Daigram gaps for GaussianNb'</span>)</span>
<span id="cb27-7"><a href="#cb27-7"></a></span>
<span id="cb27-8"><a href="#cb27-8"></a><span class="cf">for</span> x, y <span class="kw">in</span> <span class="bu">zip</span>(pred_means, y_means):</span>
<span id="cb27-9"><a href="#cb27-9"></a>    ax.arrow(x, y, y<span class="op">-</span>x, y<span class="op">-</span>y, width<span class="op">=</span><span class="fl">0.005</span>, length_includes_head<span class="op">=</span><span class="va">True</span>, color<span class="op">=</span><span class="st">'red'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-21-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="21">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1"></a><span class="im">from</span> pycalib.visualisations <span class="im">import</span> plot_binary_reliability_diagram_gaps</span>
<span id="cb28-2"><a href="#cb28-2"></a></span>
<span id="cb28-3"><a href="#cb28-3"></a>est_scores <span class="op">=</span> clf_bin.predict_proba(x_test)</span>
<span id="cb28-4"><a href="#cb28-4"></a></span>
<span id="cb28-5"><a href="#cb28-5"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb28-6"><a href="#cb28-6"></a>plot_reliability_diagram(y_test, est_scores, bins<span class="op">=</span><span class="dv">10</span>, show_bars<span class="op">=</span><span class="va">True</span>, show_gaps<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb28-7"><a href="#cb28-7"></a>                         class_names<span class="op">=</span>[<span class="st">'Neg.'</span>, <span class="st">'Pos.'</span>], fig<span class="op">=</span>fig)<span class="op">;</span></span>
<span id="cb28-8"><a href="#cb28-8"></a>plt.tight_layout()</span>
<span id="cb28-9"><a href="#cb28-9"></a>plt.savefig(<span class="st">'cal_1_vis_rel_dia_bar_gaps.pdf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-22-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="22">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">7</span>))</span>
<span id="cb29-2"><a href="#cb29-2"></a>ax1.plot(pred_means, y_means, <span class="st">'o-'</span>)</span>
<span id="cb29-3"><a href="#cb29-3"></a>ax1.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">'r--'</span>)</span>
<span id="cb29-4"><a href="#cb29-4"></a></span>
<span id="cb29-5"><a href="#cb29-5"></a><span class="cf">for</span> x, y <span class="kw">in</span> <span class="bu">zip</span>(pred_means, y_means):</span>
<span id="cb29-6"><a href="#cb29-6"></a>    ax1.arrow(x, y, y<span class="op">-</span>x, y<span class="op">-</span>y, width<span class="op">=</span><span class="fl">0.007</span>, length_includes_head<span class="op">=</span><span class="va">True</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb29-7"><a href="#cb29-7"></a>    </span>
<span id="cb29-8"><a href="#cb29-8"></a><span class="co">#for x, y in zip(pred_means, y_means):</span></span>
<span id="cb29-9"><a href="#cb29-9"></a><span class="co">#    ax1.arrow(x, y, x-x, x-y, color='red', head_width=None)</span></span>
<span id="cb29-10"><a href="#cb29-10"></a></span>
<span id="cb29-11"><a href="#cb29-11"></a>ax1.set_xlim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb29-12"><a href="#cb29-12"></a>ax1.set_xlabel(<span class="st">'Mean predicted value'</span>)</span>
<span id="cb29-13"><a href="#cb29-13"></a>ax1.set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb29-14"><a href="#cb29-14"></a>ax1.set_ylabel(<span class="st">'Fraction of positives'</span>)</span>
<span id="cb29-15"><a href="#cb29-15"></a>ax1.grid()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-23-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="23">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb30-2"><a href="#cb30-2"></a>plot_reliability_diagram(y_test, est_scores, bins<span class="op">=</span><span class="dv">10</span>, show_correction<span class="op">=</span><span class="va">True</span>, class_names<span class="op">=</span>[<span class="st">'Neg.'</span>, <span class="st">'Pos.'</span>],</span>
<span id="cb30-3"><a href="#cb30-3"></a>                        fig<span class="op">=</span>fig)<span class="op">;</span></span>
<span id="cb30-4"><a href="#cb30-4"></a>plt.tight_layout()</span>
<span id="cb30-5"><a href="#cb30-5"></a>plt.savefig(<span class="st">'cal_1_vis_rel_dia_lin_corr.pdf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-24-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We can compute the Expected Calibration Error (ECE)</p>
<div class="cell" data-scrolled="true" data-execution_count="24">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1"></a><span class="im">from</span> pycalib.metrics <span class="im">import</span> ECE, MCE</span>
<span id="cb31-2"><a href="#cb31-2"></a></span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="bu">print</span>(<span class="st">'ECE = '</span>, ECE(y_test, est_scores))</span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="bu">print</span>(<span class="st">'MCE = '</span>, MCE(y_test, est_scores))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>ECE =  0.13782220005497553
MCE =  0.18665074402724735</code></pre>
</div>
</div>
<section id="multiclass" class="level3">
<h3 class="anchored" data-anchor-id="multiclass">Multiclass</h3>
<div class="cell" data-execution_count="25">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1"></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> make_classification</span>
<span id="cb33-2"><a href="#cb33-2"></a></span>
<span id="cb33-3"><a href="#cb33-3"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb33-4"><a href="#cb33-4"></a></span>
<span id="cb33-5"><a href="#cb33-5"></a>n_features <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb33-6"><a href="#cb33-6"></a>dataset_ternary <span class="op">=</span> make_classification(n_classes<span class="op">=</span><span class="dv">3</span>, n_samples<span class="op">=</span><span class="dv">10000</span>,</span>
<span id="cb33-7"><a href="#cb33-7"></a>                                    n_clusters_per_class<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb33-8"><a href="#cb33-8"></a>                                    n_features<span class="op">=</span>n_features,</span>
<span id="cb33-9"><a href="#cb33-9"></a>                                    n_informative<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb33-10"><a href="#cb33-10"></a>                                    random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb33-11"><a href="#cb33-11"></a></span>
<span id="cb33-12"><a href="#cb33-12"></a>x, y <span class="op">=</span> dataset_ternary</span>
<span id="cb33-13"><a href="#cb33-13"></a></span>
<span id="cb33-14"><a href="#cb33-14"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">7</span>))</span>
<span id="cb33-15"><a href="#cb33-15"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_features):</span>
<span id="cb33-16"><a href="#cb33-16"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(n_features):</span>
<span id="cb33-17"><a href="#cb33-17"></a>        ax <span class="op">=</span> fig.add_subplot(n_features, n_features, <span class="dv">1</span> <span class="op">+</span> i <span class="op">+</span> j<span class="op">*</span>n_features)</span>
<span id="cb33-18"><a href="#cb33-18"></a>        plt.scatter(x[:<span class="dv">100</span>,i], x[:<span class="dv">100</span>,j], c<span class="op">=</span>y[:<span class="dv">100</span>], marker<span class="op">=</span><span class="st">'.'</span>)</span>
<span id="cb33-19"><a href="#cb33-19"></a>plt.tight_layout()</span>
<span id="cb33-20"><a href="#cb33-20"></a>plt.savefig(<span class="st">'cal_1_vis_data_ternary.pdf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-26-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="26">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1"></a>x_train, x_test, y_train, y_test <span class="op">=</span> train_test_split(x, y, test_size<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb34-2"><a href="#cb34-2"></a>clf_ter <span class="op">=</span> GaussianNB()</span>
<span id="cb34-3"><a href="#cb34-3"></a>clf_ter.fit(x_train, y_train)</span>
<span id="cb34-4"><a href="#cb34-4"></a>clf_ter_2 <span class="op">=</span> KNeighborsClassifier(n_neighbors<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb34-5"><a href="#cb34-5"></a>clf_ter_2.fit(x_train, y_train)</span>
<span id="cb34-6"><a href="#cb34-6"></a></span>
<span id="cb34-7"><a href="#cb34-7"></a>scores_list <span class="op">=</span> [clf_ter.predict_proba(x_test),</span>
<span id="cb34-8"><a href="#cb34-8"></a>               clf_ter_2.predict_proba(x_test)]</span>
<span id="cb34-9"><a href="#cb34-9"></a></span>
<span id="cb34-10"><a href="#cb34-10"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">2.3</span>))</span>
<span id="cb34-11"><a href="#cb34-11"></a>_ <span class="op">=</span> plot_reliability_diagram(y_test, scores_list, legend<span class="op">=</span>(<span class="st">'NaiveBayes'</span>, <span class="st">'KNN (k=10)'</span>), bins<span class="op">=</span>n_bins,</span>
<span id="cb34-12"><a href="#cb34-12"></a>                            fig<span class="op">=</span>fig)</span>
<span id="cb34-13"><a href="#cb34-13"></a>plt.tight_layout()</span>
<span id="cb34-14"><a href="#cb34-14"></a>plt.savefig(<span class="st">'cal_1_vis_rel_dia_nb_knn_ternary.pdf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-27-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="27">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb35-2"><a href="#cb35-2"></a>_ <span class="op">=</span> plot_reliability_diagram(y_test, scores_list, legend<span class="op">=</span>(<span class="st">'NaiveBayes'</span>, <span class="st">'KNN (k=10)'</span>), confidence<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span>bins,</span>
<span id="cb35-3"><a href="#cb35-3"></a>                            fig<span class="op">=</span>fig)</span>
<span id="cb35-4"><a href="#cb35-4"></a>plt.tight_layout()</span>
<span id="cb35-5"><a href="#cb35-5"></a>plt.savefig(<span class="st">'cal_1_vis_rel_dia_nb_knn_conf_ternary.pdf'</span>,</span>
<span id="cb35-6"><a href="#cb35-6"></a>            bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-28-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>In the multiclass case we can focus on the most confident score per sample, and plot only the proportion of correct predictions in each bin.</p>
<p>The following plots only show the results for the first classifier.</p>
<div class="cell" data-execution_count="28">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1"></a><span class="im">from</span> pycalib.visualisations <span class="im">import</span> plot_multiclass_reliability_diagram_gaps</span>
<span id="cb36-2"><a href="#cb36-2"></a></span>
<span id="cb36-3"><a href="#cb36-3"></a><span class="co">#x, y = dataset_ternary</span></span>
<span id="cb36-4"><a href="#cb36-4"></a><span class="co">#x_train, x_test, y_train, y_test = train_test_split(x, y, test_size=0.5)</span></span>
<span id="cb36-5"><a href="#cb36-5"></a><span class="co">#clf = GaussianNB()</span></span>
<span id="cb36-6"><a href="#cb36-6"></a><span class="co">#clf.fit(x_train, y_train)</span></span>
<span id="cb36-7"><a href="#cb36-7"></a></span>
<span id="cb36-8"><a href="#cb36-8"></a>probas <span class="op">=</span> clf_ter.predict_proba(x_test)</span>
<span id="cb36-9"><a href="#cb36-9"></a>_ <span class="op">=</span> plot_multiclass_reliability_diagram_gaps(y_test, probas, per_class<span class="op">=</span><span class="va">False</span>, n_bins<span class="op">=</span>n_bins)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-29-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="29">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb37-2"><a href="#cb37-2"></a>_ <span class="op">=</span> plot_reliability_diagram(y_test, probas, show_bars<span class="op">=</span><span class="va">True</span>, show_gaps<span class="op">=</span><span class="va">True</span>, confidence<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span>n_bins, fig<span class="op">=</span>fig)</span>
<span id="cb37-3"><a href="#cb37-3"></a>plt.tight_layout()</span>
<span id="cb37-4"><a href="#cb37-4"></a>plt.savefig(<span class="st">'cal_1_vis_rel_dia_conf_ternary.pdf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-30-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We can compute the confidence-ECE which only computes expected gap size in the previous plot</p>
<p><span class="math display">
    \mathsf{confidence{-}ECE}  = \sum_{i=1}^M \frac{|B_{i}|}{N} |\bar{y}(B_{i}) - \bar{p}(B_{i})|
</span></p>
<div class="cell" data-execution_count="30">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1"></a><span class="im">from</span> pycalib.metrics <span class="im">import</span> conf_ECE, conf_MCE</span>
<span id="cb38-2"><a href="#cb38-2"></a></span>
<span id="cb38-3"><a href="#cb38-3"></a><span class="bu">print</span>(<span class="st">'Naive Bayes conf-ECE = '</span>, conf_ECE(y_test, probas, bins<span class="op">=</span>n_bins))</span>
<span id="cb38-4"><a href="#cb38-4"></a><span class="bu">print</span>(<span class="st">'KNN conf-ECE = '</span>, conf_ECE(y_test, clf_ter_2.predict_proba(x_test), bins<span class="op">=</span>n_bins))</span>
<span id="cb38-5"><a href="#cb38-5"></a></span>
<span id="cb38-6"><a href="#cb38-6"></a><span class="bu">print</span>(<span class="st">'Naive Bayes conf-ECE = '</span>, conf_MCE(y_test, probas, bins<span class="op">=</span>n_bins))</span>
<span id="cb38-7"><a href="#cb38-7"></a><span class="bu">print</span>(<span class="st">'KNN conf-ECE = '</span>, conf_MCE(y_test, clf_ter_2.predict_proba(x_test), bins<span class="op">=</span>n_bins))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Naive Bayes conf-ECE =  0.10073120102612733
KNN conf-ECE =  0.033760000000003856
Naive Bayes conf-ECE =  0.2332292123860582
KNN conf-ECE =  0.0428745432399551</code></pre>
</div>
</div>
<p>or the maximum gap with the confidence-MCE:</p>
<p><span class="math display">
\mathsf{confidence{-}MCE} = \max_{i \in \{1, \ldots, M\}} |\bar{y}(B_i) - \bar{p}(B_i)|
</span></p>
<div class="cell" data-execution_count="31">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1"></a><span class="im">from</span> pycalib.metrics <span class="im">import</span> conf_MCE</span>
<span id="cb40-2"><a href="#cb40-2"></a></span>
<span id="cb40-3"><a href="#cb40-3"></a><span class="bu">print</span>(<span class="st">'conf-MCE = '</span>, conf_MCE(y_test, probas, bins<span class="op">=</span>n_bins))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>conf-MCE =  0.2332292123860582</code></pre>
</div>
</div>
<p>Instead of only showing the most confident prediction, we can show the scores for each class</p>
<div class="cell" data-execution_count="32">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb42-2"><a href="#cb42-2"></a>_ <span class="op">=</span> plot_multiclass_reliability_diagram_gaps(y_test, probas, per_class<span class="op">=</span><span class="va">True</span>, fig<span class="op">=</span>fig, n_bins<span class="op">=</span>n_bins)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-33-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="33">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">2.3</span>))</span>
<span id="cb43-2"><a href="#cb43-2"></a>_ <span class="op">=</span> plot_reliability_diagram(y_test, probas, show_bars<span class="op">=</span><span class="va">True</span>, show_gaps<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span>n_bins,</span>
<span id="cb43-3"><a href="#cb43-3"></a>                             fig<span class="op">=</span>fig)</span>
<span id="cb43-4"><a href="#cb43-4"></a>plt.tight_layout()</span>
<span id="cb43-5"><a href="#cb43-5"></a><span class="co">#plt.margins(x=0)</span></span>
<span id="cb43-6"><a href="#cb43-6"></a>plt.savefig(<span class="st">'cal_1_vis_rel_dia_ternary.pdf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-34-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>With the previous figure we can get an intuition about how the classwise-ECE is computed, as the expected gap size across all the classes</p>
<p><span class="math display">
\mathsf{classwise{-}ECE}  = \frac{1}{K}\sum_{j=1}^K \sum_{i=1}^M \frac{|B_{i,j}|}{N} |\bar{y}_j(B_{i,j}) - \bar{p}_j(B_{i,j})|,
</span></p>
<div class="cell" data-execution_count="34">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1"></a><span class="im">from</span> pycalib.metrics <span class="im">import</span> classwise_ECE</span>
<span id="cb44-2"><a href="#cb44-2"></a></span>
<span id="cb44-3"><a href="#cb44-3"></a><span class="bu">print</span>(<span class="st">'Naive Bayes classwise-ECE = '</span>, classwise_ECE(y_test, probas, bins<span class="op">=</span>n_bins))</span>
<span id="cb44-4"><a href="#cb44-4"></a><span class="bu">print</span>(<span class="st">'KNN classwise-ECE = '</span>, classwise_ECE(y_test, clf_ter_2.predict_proba(x_test), bins<span class="op">=</span>n_bins))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Naive Bayes classwise-ECE =  0.07306931580191046
KNN classwise-ECE =  0.025426666666666653</code></pre>
</div>
</div>
<p>the classwise-MCE needs to be added, as well as the statistical tests.</p>
</section>
</section>
<section id="calibration-maps" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="calibration-maps"><span class="header-section-number">6.4</span> Calibration maps</h2>
<p>Calibration maps show the transformation that the calibrator performs to the classifier’s scores. This is a map function from <span class="math inline">C</span> to <span class="math inline">C</span> where <span class="math inline">C</span> is the number of classes. In the binary case it is comonly shown for the positive class</p>
<section id="binary" class="level3">
<h3 class="anchored" data-anchor-id="binary">Binary</h3>
<p>We will load again the binary dataset that we created earlier</p>
<div class="cell" data-execution_count="35">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1"></a>x, y <span class="op">=</span> dataset_binary</span>
<span id="cb46-2"><a href="#cb46-2"></a>x_train, x_test, y_train, y_test <span class="op">=</span> train_test_split(x, y, test_size<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we will need a calibrator in order to show the mapping function. We will train here a classifier with a calibrator on top.</p>
<div class="cell" data-execution_count="36">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1"></a><span class="im">from</span> pycalib.models <span class="im">import</span> CalibratedModel, IsotonicCalibration</span>
<span id="cb47-2"><a href="#cb47-2"></a></span>
<span id="cb47-3"><a href="#cb47-3"></a>cal_bin <span class="op">=</span> CalibratedModel(clf_bin, IsotonicCalibration())</span>
<span id="cb47-4"><a href="#cb47-4"></a>cal_bin.fit(x_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>CalibratedModel(base_estimator=GaussianNB(), calibrator=IsotonicCalibration())</code></pre>
</div>
</div>
<p>In the binary case the calibration map corresponds to a 1 to 1 function that can be visualised in two dimensions with the scores of the classifier in the <span class="math inline">x</span> axis, and the corresponding probabilities from the calibrator in the <span class="math inline">y</span> axis.</p>
<div class="cell" data-execution_count="37">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1"></a>scores_linspace <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">50</span>)</span>
<span id="cb49-2"><a href="#cb49-2"></a>scores_linspace <span class="op">=</span> np.vstack((<span class="dv">1</span><span class="op">-</span>scores_linspace, scores_linspace)).T</span>
<span id="cb49-3"><a href="#cb49-3"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb49-4"><a href="#cb49-4"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>)</span>
<span id="cb49-5"><a href="#cb49-5"></a>calibrated <span class="op">=</span> cal_bin.calibrator.predict_proba(scores_linspace)</span>
<span id="cb49-6"><a href="#cb49-6"></a>ax.plot(scores_linspace[:, <span class="dv">1</span>], calibrated[:, <span class="dv">1</span>], label<span class="op">=</span><span class="st">'Isotonic'</span>)</span>
<span id="cb49-7"><a href="#cb49-7"></a>ax.legend()</span>
<span id="cb49-8"><a href="#cb49-8"></a>ax.set_xlabel(<span class="st">'Scores'</span>)</span>
<span id="cb49-9"><a href="#cb49-9"></a>ax.set_ylabel(<span class="st">'Calibrated scores'</span>)</span>
<span id="cb49-10"><a href="#cb49-10"></a>ax.set_xlim([<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb49-11"><a href="#cb49-11"></a>ax.set_ylim([<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb49-12"><a href="#cb49-12"></a>ax.grid()</span>
<span id="cb49-13"><a href="#cb49-13"></a>plt.tight_layout()</span>
<span id="cb49-14"><a href="#cb49-14"></a>plt.savefig(<span class="st">'cal_1_vis_cal_map_binary.pdf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-39-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Notice the similarity to the reliability diagram of the classifier, as the calibrator is trying to correct the misscalibration by fitting the scores as best as possible.</p>
<div class="cell" data-execution_count="38">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb50-2"><a href="#cb50-2"></a>_ <span class="op">=</span> plot_reliability_diagram(y_test, [cal_bin.base_estimator.predict_proba(x_test),</span>
<span id="cb50-3"><a href="#cb50-3"></a>                                      cal_bin.predict_proba(x_test)],</span>
<span id="cb50-4"><a href="#cb50-4"></a>                             legend<span class="op">=</span>(<span class="st">'NaiveBayes'</span>, <span class="st">' + Isotonic'</span>), class_names<span class="op">=</span>[<span class="st">'Neg.'</span>, <span class="st">'Pos.'</span>],</span>
<span id="cb50-5"><a href="#cb50-5"></a>                             bins<span class="op">=</span>n_bins, fig<span class="op">=</span>fig)</span>
<span id="cb50-6"><a href="#cb50-6"></a>plt.tight_layout()</span>
<span id="cb50-7"><a href="#cb50-7"></a>plt.savefig(<span class="st">'cal_1_vis_rel_dia_cal_map_nb_binary.pdf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-40-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="39">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1"></a>aux_scores <span class="op">=</span> cal_bin.predict_proba(x_test)</span>
<span id="cb51-2"><a href="#cb51-2"></a>aux_prediction <span class="op">=</span> np.argmax(aux_scores, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb51-3"><a href="#cb51-3"></a>accuracy <span class="op">=</span> np.mean(aux_prediction <span class="op">==</span> y_test)</span>
<span id="cb51-4"><a href="#cb51-4"></a><span class="bu">print</span>(<span class="st">'Accuracy '</span>, accuracy)</span>
<span id="cb51-5"><a href="#cb51-5"></a>aux_confidence <span class="op">=</span> np.<span class="bu">max</span>(aux_scores, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb51-6"><a href="#cb51-6"></a>idx_correct <span class="op">=</span> aux_prediction <span class="op">==</span> y_test</span>
<span id="cb51-7"><a href="#cb51-7"></a>idx_incorrect <span class="op">=</span> aux_prediction <span class="op">!=</span> y_test</span>
<span id="cb51-8"><a href="#cb51-8"></a>plt.hist([aux_confidence[idx_correct], aux_confidence[idx_incorrect]])</span>
<span id="cb51-9"><a href="#cb51-9"></a><span class="co">#plt.hist(aux_confidence)</span></span>
<span id="cb51-10"><a href="#cb51-10"></a>aux_bin <span class="op">=</span> [<span class="fl">0.9</span>, <span class="fl">1.0</span>]</span>
<span id="cb51-11"><a href="#cb51-11"></a>aux_indices <span class="op">=</span> (aux_confidence <span class="op">&gt;</span> aux_bin[<span class="dv">0</span>]) <span class="op">&amp;</span> (aux_confidence <span class="op">&lt;</span> aux_bin[<span class="dv">1</span>])</span>
<span id="cb51-12"><a href="#cb51-12"></a>aux_correct <span class="op">=</span> np.<span class="bu">sum</span>(aux_prediction[aux_indices] <span class="op">==</span> y_test[aux_indices])</span>
<span id="cb51-13"><a href="#cb51-13"></a>aux_incorrect <span class="op">=</span> np.<span class="bu">sum</span>(aux_prediction[aux_indices] <span class="op">!=</span> y_test[aux_indices])</span>
<span id="cb51-14"><a href="#cb51-14"></a><span class="bu">print</span>(<span class="st">'Correct = '</span>, aux_correct)</span>
<span id="cb51-15"><a href="#cb51-15"></a><span class="bu">print</span>(<span class="st">'Incorrect = '</span>, aux_incorrect)</span>
<span id="cb51-16"><a href="#cb51-16"></a><span class="bu">print</span>(<span class="st">'Accuracy = '</span>, aux_correct<span class="op">/</span>(aux_correct <span class="op">+</span> aux_incorrect))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Accuracy  0.843
Correct =  486
Incorrect =  19
Accuracy =  0.9623762376237623</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-41-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="40">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1"></a>cal_bin.predict_proba(x_test).shape</span>
<span id="cb53-2"><a href="#cb53-2"></a>y_test.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>(5000,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="41">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1"></a>_ <span class="op">=</span> plot_reliability_diagram(y_test, [cal_bin.base_estimator.predict_proba(x_test),</span>
<span id="cb55-2"><a href="#cb55-2"></a>                                      cal_bin.predict_proba(x_test)],</span>
<span id="cb55-3"><a href="#cb55-3"></a>                             legend<span class="op">=</span>(<span class="st">'NaiveBayes'</span>, <span class="st">' + Isotonic'</span>), class_names<span class="op">=</span>[<span class="st">'Neg.'</span>, <span class="st">'Pos.'</span>],</span>
<span id="cb55-4"><a href="#cb55-4"></a>                             bins<span class="op">=</span>n_bins, confidence<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb55-5"><a href="#cb55-5"></a>plt.tight_layout()</span>
<span id="cb55-6"><a href="#cb55-6"></a>plt.savefig(<span class="st">'cal_1_vis_rel_dia_cal_map_nb_conf_binary.pdf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="Calibration example_files/figure-html/cell-43-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="42">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1"></a><span class="bu">print</span>(<span class="st">'Naive Bayes bin-ECE = '</span>, binary_ECE(y_test, cal_bin.base_estimator.predict_proba(x_test)[:,<span class="dv">1</span>], bins<span class="op">=</span>n_bins))</span>
<span id="cb56-2"><a href="#cb56-2"></a><span class="bu">print</span>(<span class="st">'+ Isotonic bin-ECE = '</span>, binary_ECE(y_test,  cal_bin.predict_proba(x_test)[:,<span class="dv">1</span>], bins<span class="op">=</span>n_bins))</span>
<span id="cb56-3"><a href="#cb56-3"></a></span>
<span id="cb56-4"><a href="#cb56-4"></a><span class="bu">print</span>(<span class="st">'Naive Bayes bin-MCE = '</span>, binary_MCE(y_test, cal_bin.base_estimator.predict_proba(x_test)[:,<span class="dv">1</span>], bins<span class="op">=</span>n_bins))</span>
<span id="cb56-5"><a href="#cb56-5"></a><span class="bu">print</span>(<span class="st">'+ Isotonic bin-MCE = '</span>, binary_MCE(y_test,  cal_bin.predict_proba(x_test)[:,<span class="dv">1</span>], bins<span class="op">=</span>n_bins))</span>
<span id="cb56-6"><a href="#cb56-6"></a></span>
<span id="cb56-7"><a href="#cb56-7"></a><span class="bu">print</span>(<span class="st">'Naive Bayes conf-ECE = '</span>, conf_ECE(y_test, cal_bin.base_estimator.predict_proba(x_test), bins<span class="op">=</span>n_bins))</span>
<span id="cb56-8"><a href="#cb56-8"></a><span class="bu">print</span>(<span class="st">'+ Isotonic conf-ECE = '</span>, conf_ECE(y_test,  cal_bin.predict_proba(x_test), bins<span class="op">=</span>n_bins))</span>
<span id="cb56-9"><a href="#cb56-9"></a></span>
<span id="cb56-10"><a href="#cb56-10"></a><span class="bu">print</span>(<span class="st">'Naive Bayes conf-MCE = '</span>, conf_MCE(y_test, cal_bin.base_estimator.predict_proba(x_test), bins<span class="op">=</span>n_bins))</span>
<span id="cb56-11"><a href="#cb56-11"></a><span class="bu">print</span>(<span class="st">'+ Isotonic conf-MCE = '</span>, conf_MCE(y_test,  cal_bin.predict_proba(x_test), bins<span class="op">=</span>n_bins))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Naive Bayes bin-ECE =  0.079496190619477
+ Isotonic bin-ECE =  0.01156162517476712
Naive Bayes bin-MCE =  0.1753553512921694
+ Isotonic bin-MCE =  0.19255158274553785
Naive Bayes conf-ECE =  0.07949619061947717
+ Isotonic conf-ECE =  0.009154236420034963
Naive Bayes conf-MCE =  0.1491809427878793
+ Isotonic conf-MCE =  0.5</code></pre>
</div>
</div>
</section>
<section id="ternary-calibration-maps" class="level3">
<h3 class="anchored" data-anchor-id="ternary-calibration-maps">Ternary Calibration maps</h3>
<p>It is possible to visualise a calibration map for ternary classification problems. We will start by loading the ternary dataset, and training a classifier and a calibrator on top.</p>
<div class="cell" data-execution_count="43">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1"></a><span class="im">from</span> dirichletcal <span class="im">import</span> FullDirichletCalibrator</span>
<span id="cb58-2"><a href="#cb58-2"></a><span class="im">from</span> pycalib.metrics <span class="im">import</span> classwise_MCE</span>
<span id="cb58-3"><a href="#cb58-3"></a></span>
<span id="cb58-4"><a href="#cb58-4"></a>x, y <span class="op">=</span> dataset_ternary</span>
<span id="cb58-5"><a href="#cb58-5"></a>x_train, x_test, y_train, y_test <span class="op">=</span> train_test_split(x, y, test_size<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb58-6"><a href="#cb58-6"></a>cal_ter <span class="op">=</span> CalibratedModel(clf_ter, FullDirichletCalibrator())</span>
<span id="cb58-7"><a href="#cb58-7"></a>cal_ter.fit(x_train, y_train)</span>
<span id="cb58-8"><a href="#cb58-8"></a></span>
<span id="cb58-9"><a href="#cb58-9"></a><span class="bu">print</span>(<span class="st">'Naive Bayes confidence-ECE = '</span>, conf_ECE(y_test, clf_ter.predict_proba(x_test), bins<span class="op">=</span>n_bins))</span>
<span id="cb58-10"><a href="#cb58-10"></a><span class="bu">print</span>(<span class="st">'+ Dirichlet confidence-ECE = '</span>, conf_ECE(y_test, cal_ter.predict_proba(x_test), bins<span class="op">=</span>n_bins))</span>
<span id="cb58-11"><a href="#cb58-11"></a></span>
<span id="cb58-12"><a href="#cb58-12"></a><span class="bu">print</span>(<span class="st">'Naive Bayes confidence-MCE = '</span>, conf_MCE(y_test, clf_ter.predict_proba(x_test), bins<span class="op">=</span>n_bins))</span>
<span id="cb58-13"><a href="#cb58-13"></a><span class="bu">print</span>(<span class="st">'+ Dirichlet confidence-MCE = '</span>, conf_MCE(y_test, cal_ter.predict_proba(x_test), bins<span class="op">=</span>n_bins))</span>
<span id="cb58-14"><a href="#cb58-14"></a></span>
<span id="cb58-15"><a href="#cb58-15"></a><span class="bu">print</span>(<span class="st">'Naive Bayes classwise-ECE = '</span>, classwise_ECE(y_test, clf_ter.predict_proba(x_test), bins<span class="op">=</span>n_bins))</span>
<span id="cb58-16"><a href="#cb58-16"></a><span class="bu">print</span>(<span class="st">'+ Dirichlet classwise-ECE = '</span>, classwise_ECE(y_test, cal_ter.predict_proba(x_test), bins<span class="op">=</span>n_bins))</span>
<span id="cb58-17"><a href="#cb58-17"></a></span>
<span id="cb58-18"><a href="#cb58-18"></a><span class="bu">print</span>(<span class="st">'Naive Bayes classwise-MCE = '</span>, classwise_MCE(y_test, clf_ter.predict_proba(x_test), bins<span class="op">=</span>n_bins))</span>
<span id="cb58-19"><a href="#cb58-19"></a><span class="bu">print</span>(<span class="st">'+ Dirichlet classwise-MCE = '</span>, classwise_MCE(y_test, cal_ter.predict_proba(x_test), bins<span class="op">=</span>n_bins))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-error">
<pre><code>ModuleNotFoundError: No module named 'dirichletcal'</code></pre>
</div>
</div>
<p>With 3 classes the calibration map corresponds to a function from 3 to 3 dimensions. As this is difficult to visualise we propose several approaches that show part of the map.</p>
<p>We will first obtain a 2D mesh in the simplex, trying to cover most of the space</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1"></a><span class="im">from</span> pycalib.visualisations.barycentric <span class="im">import</span> get_mesh_bc</span>
<span id="cb60-2"><a href="#cb60-2"></a>P_bc_grid <span class="op">=</span> get_mesh_bc(subdiv<span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we will obtain the predicted probabilities output by our calibrator for each of the points in the mesh.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1"></a>calibrated <span class="op">=</span> cal_ter.calibrator.predict_proba(P_bc_grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>One way is to consider that the input and output scores live in a 2D simplex. This means that we can visualise the mapping from an input and output scores as a 2D coordinates. Then we will show both coordinates as the begining and end of an arrow.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1"></a><span class="im">from</span> pycalib.visualisations.barycentric <span class="im">import</span> draw_calibration_map</span>
<span id="cb62-2"><a href="#cb62-2"></a></span>
<span id="cb62-3"><a href="#cb62-3"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">3</span>))</span>
<span id="cb62-4"><a href="#cb62-4"></a>_ <span class="op">=</span> draw_calibration_map(P_bc_grid, calibrated,  subdiv<span class="op">=</span><span class="dv">4</span>, fig<span class="op">=</span>fig)</span>
<span id="cb62-5"><a href="#cb62-5"></a>plt.tight_layout()</span>
<span id="cb62-6"><a href="#cb62-6"></a>plt.savefig(<span class="st">'cal_1_vis_cal_map_ternary.pdf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can also paint the arrows in three different colors, one per class. We will paint them indicating the most confident class at the tip of the arrow (output of the calibrator).</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1"></a>color_list <span class="op">=</span> [<span class="st">'Red'</span>, <span class="st">'Orange'</span>, <span class="st">'Blue'</span>]</span>
<span id="cb63-2"><a href="#cb63-2"></a>color <span class="op">=</span> [color_list[i] <span class="cf">for</span> i <span class="kw">in</span> calibrated.argmax(axis<span class="op">=</span><span class="dv">1</span>).astype(<span class="bu">int</span>)]</span>
<span id="cb63-3"><a href="#cb63-3"></a></span>
<span id="cb63-4"><a href="#cb63-4"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">3</span>))</span>
<span id="cb63-5"><a href="#cb63-5"></a>_ <span class="op">=</span> draw_calibration_map(P_bc_grid, calibrated, color<span class="op">=</span>color,  subdiv<span class="op">=</span><span class="dv">4</span>, fig<span class="op">=</span>fig)</span>
<span id="cb63-6"><a href="#cb63-6"></a>plt.tight_layout()</span>
<span id="cb63-7"><a href="#cb63-7"></a>plt.savefig(<span class="st">'cal_1_vis_cal_map_ternary_color.pdf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Another way is to show 3 calibration maps from 3 to 1 dimension. Each calibration map shows the full input score to the calibrator, and only one of the classes’ output. The input then will be shown as the position in a 2D simplex, while the output is shown as a heatmap.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1"></a><span class="im">from</span> pycalib.visualisations.ternary <span class="im">import</span> draw_func_contours, plot_converging_lines_pvalues, get_converging_lines</span>
<span id="cb64-2"><a href="#cb64-2"></a></span>
<span id="cb64-3"><a href="#cb64-3"></a>cmap_list <span class="op">=</span> [<span class="st">'Reds'</span>, <span class="st">'Oranges'</span>, <span class="st">'Blues'</span>]</span>
<span id="cb64-4"><a href="#cb64-4"></a></span>
<span id="cb64-5"><a href="#cb64-5"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">3</span>))</span>
<span id="cb64-6"><a href="#cb64-6"></a><span class="cf">for</span> i, c <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">'C1'</span>, <span class="st">'C2'</span>, <span class="st">'C3'</span>]):</span>
<span id="cb64-7"><a href="#cb64-7"></a>    ax <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>, <span class="dv">3</span>, i<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb64-8"><a href="#cb64-8"></a>    ax.set_title(<span class="st">'$C_</span><span class="sc">{}</span><span class="st">$'</span>.<span class="bu">format</span>(i<span class="op">+</span><span class="dv">1</span>), loc<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb64-9"><a href="#cb64-9"></a></span>
<span id="cb64-10"><a href="#cb64-10"></a>    function <span class="op">=</span> <span class="kw">lambda</span> x: cal_ter.calibrator.predict_proba(x.reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>))[<span class="dv">0</span>][i]</span>
<span id="cb64-11"><a href="#cb64-11"></a>    draw_func_contours(function, labels<span class="op">=</span>[<span class="st">'$C_1$'</span>, <span class="st">'$C_2$'</span>, <span class="st">'$C_3$'</span>], fig<span class="op">=</span>fig, ax<span class="op">=</span>ax, cmap<span class="op">=</span>cmap_list[i])</span>
<span id="cb64-12"><a href="#cb64-12"></a>plt.tight_layout()</span>
<span id="cb64-13"><a href="#cb64-13"></a>plt.savefig(<span class="st">'cal_1_vis_rel_diag_ternary.pdf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Notice that we can cut arbitrary sections on the previous calibration maps and obtain cross-sections that can be visualised as binary calibration maps.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1"></a><span class="im">from</span> pycalib.visualisations.ternary <span class="im">import</span> plot_converging_lines_pvalues, get_converging_lines</span>
<span id="cb65-2"><a href="#cb65-2"></a></span>
<span id="cb65-3"><a href="#cb65-3"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb65-4"><a href="#cb65-4"></a><span class="cf">for</span> i, c <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">'C1'</span>, <span class="st">'C2'</span>, <span class="st">'C3'</span>]):</span>
<span id="cb65-5"><a href="#cb65-5"></a>    ax <span class="op">=</span> fig.add_subplot(<span class="dv">2</span>, <span class="dv">3</span>, i<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb65-6"><a href="#cb65-6"></a></span>
<span id="cb65-7"><a href="#cb65-7"></a>    ax.set_title(<span class="st">'$C_</span><span class="sc">{}</span><span class="st">$'</span>.<span class="bu">format</span>(i<span class="op">+</span><span class="dv">1</span>), loc<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb65-8"><a href="#cb65-8"></a></span>
<span id="cb65-9"><a href="#cb65-9"></a>    function <span class="op">=</span> <span class="kw">lambda</span> x: cal_ter.calibrator.predict_proba(x.reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>))[<span class="dv">0</span>][i]</span>
<span id="cb65-10"><a href="#cb65-10"></a>    draw_func_contours(function, labels<span class="op">=</span>[<span class="st">'$C_1$'</span>, <span class="st">'$C_2$'</span>, <span class="st">'$C_3$'</span>], fig<span class="op">=</span>fig, ax<span class="op">=</span>ax, cmap<span class="op">=</span>cmap_list[i],</span>
<span id="cb65-11"><a href="#cb65-11"></a>                       nlevels<span class="op">=</span><span class="dv">100</span>, subdiv<span class="op">=</span><span class="dv">4</span>, draw_lines<span class="op">=</span><span class="dv">5</span>, class_index<span class="op">=</span>i)</span>
<span id="cb65-12"><a href="#cb65-12"></a></span>
<span id="cb65-13"><a href="#cb65-13"></a>    ax2 <span class="op">=</span> fig.add_subplot(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span><span class="op">+</span>i<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb65-14"><a href="#cb65-14"></a>    lines <span class="op">=</span> get_converging_lines(num_lines<span class="op">=</span><span class="dv">5</span>, mesh_precision<span class="op">=</span><span class="dv">20</span>, class_index<span class="op">=</span>i)</span>
<span id="cb65-15"><a href="#cb65-15"></a>    plot_converging_lines_pvalues(function, lines, i, ax2)</span>
<span id="cb65-16"><a href="#cb65-16"></a>plt.tight_layout()</span>
<span id="cb65-17"><a href="#cb65-17"></a>plt.savefig(<span class="st">'cal_1_vis_rel_diag_ternary_lines.pdf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In the following figure we show side by side the previous calibration maps</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb66-2"><a href="#cb66-2"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">1</span>)</span>
<span id="cb66-3"><a href="#cb66-3"></a>fig <span class="op">=</span> draw_calibration_map(P_bc_grid, calibrated, color<span class="op">=</span>color, subdiv<span class="op">=</span><span class="dv">5</span>, fig<span class="op">=</span>fig, ax<span class="op">=</span>ax, alpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb66-4"><a href="#cb66-4"></a></span>
<span id="cb66-5"><a href="#cb66-5"></a><span class="cf">for</span> i, c <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">'C1'</span>, <span class="st">'C2'</span>, <span class="st">'C3'</span>]):</span>
<span id="cb66-6"><a href="#cb66-6"></a>    ax <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>, <span class="dv">4</span>, i<span class="op">+</span><span class="dv">2</span>)</span>
<span id="cb66-7"><a href="#cb66-7"></a>    ax.set_title(<span class="st">'$C_</span><span class="sc">{}</span><span class="st">$'</span>.<span class="bu">format</span>(i<span class="op">+</span><span class="dv">1</span>), loc<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb66-8"><a href="#cb66-8"></a></span>
<span id="cb66-9"><a href="#cb66-9"></a>    function <span class="op">=</span> <span class="kw">lambda</span> x: cal_ter.calibrator.predict_proba(x.reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>))[<span class="dv">0</span>][i]</span>
<span id="cb66-10"><a href="#cb66-10"></a>    draw_func_contours(function, labels<span class="op">=</span>[<span class="st">'$C_1$'</span>, <span class="st">'$C_2$'</span>, <span class="st">'$C_3$'</span>], fig<span class="op">=</span>fig, ax<span class="op">=</span>ax, cmap<span class="op">=</span>cmap_list[i])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation column-body">
  <div class="nav-page nav-page-previous">
      <a href="../cha_wahcc/wahcc.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Classifier Calibration</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../safety-and-robustness.html" class="pagination-link">
        <span class="nav-page-text">(Safety and Robustness)</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Foundations of Trustworthy AI was written by Miquel Perello Nieto by compiling multiple information from the TAILOR project.</div>   
    <div class="nav-footer-right">This book was built with <a href="https://quarto.org/">Quarto</a>.</div>
  </div>
</footer>



</body></html>